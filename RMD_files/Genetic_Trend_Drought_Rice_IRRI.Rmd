---
title: "Historical Data Analysi and Genetic Trend of Drought trials at IRRI HQ"
author: "Prepared by: Waseem Hussain and Apurva Khanna"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: readable
    highlight: haddock
    toc: true
    number_sections: true
    toc_depth: 5
    toc_float: 
      collapsed: true
      smooth_scroll: true
---

<style type="text/css">

body 
{
   font-size: 18px;
} 
code.r{
  font-size: 18px;
} 
pre {
  font-size: 18px
}

h1.title 
{/* Header 1 */
  font-size: 40px;
  font-family:  "Times New Roman", Times, serif;
  color: black;
   background-color:white;
  text-transform: Capitalize;
} 
h1 { /* Header 1 */
  font-size: 30px;
  font-family: "Times New Roman", Times, serif;
  color: black;
  background-color:#FFF0F5;
  text-transform: none;
} 
h2 { /* Header 2 */
  font-size: 25px;
  font-family: "Times New Roman", Times, serif;
  color: darkblue;
  text-transform: none;
} 
h3 { /* Header 3 */
  font-size: 22px;
  font-family: "Times New Roman", Times, serif;
  color: DarkRed;
  text-transform: none;
} 
h4 { /* Header 4 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: Darkred;
  text-transform: none;
} 

</style>

```{r knitr_init}
library(knitr)
## Global options
options(max.print="100")
opts_chunk$set(echo=TRUE,
               cache=TRUE,
               prompt=TRUE,
               collapse=TRUE,
               comment=NA,
               strip.white=TRUE,
               message=FALSE,
               warning=FALSE,
               width=65,
               tidy.opts=list(width.cutoff=65, tidy=TRUE))
```


```{r setup, include=FALSE, echo=FALSE}
    require("knitr")
  opts_knit$set(root.dir = "/Volumes/GoogleDrive/My Drive/Rainfed_Breeding_Lead/Historical_Data_analysis/Drought")
```


# Load the required libraries

```{r}
# Load the Libraries
    library(asreml)
    library(multtest)
    library(dplyr)
    library(readxl)
    library(breakDown)
    library(dplyr)
    library(ggplot2)
    library(plotly)
    library(DT)
    library(xlsx)
    library(gghighlight)
    library(MASS) 
    library(reshape2) 
    library(reshape) 
    library(pheatmap)
    library(FMradio)
    library(gridExtra)
    library(ggpubr)
    library(AGHmatrix)
    library(factoextra)
    library(FactoMineR)
```

# Read the Data

```{r, eval=FALSE}
# Remove the previous work 
    rm(list=ls())
# Set the Working Directory first
   setwd("/Volumes/GoogleDrive/My Drive/Rainfed_Breeding_Lead/Historical_Data_analysis/Drought")
# Read the raw data in Data folder
    raw.data<-read.csv(file="./Data/AYT_Raw.Data.final.csv",
                     header = TRUE, sep=",", stringsAsFactors =FALSE)
```

# Pre-processing and Quality Check of Data

## Factor Conversions

```{r, eval=FALSE}
#Check the structure of the data
    str(raw.data)
    raw.data<-data.frame(raw.data)
# Covert the variable. Here we will develop the separate functions.
# Characters/numeric to factors
    chtofact<- function(x, colvec){
    for(i in 1:length(colvec)){
    x[,colvec[i]]<- as.factor(x[,colvec[i]])
    }
    return(x)
    }
# Characters/factors to numeric
    chtonumr<- function(x, colvec){
     for(i in 1:length(colvec)){
       x[,colvec[i]]<- as.numeric(x[,colvec[i]])
      }
      return(x)
    }
# Characters to factors
    raw.data<- chtofact(raw.data, c("Year", "Season","Treatment", "Design", "GID",
                                "Study_Name", "Rep","Entry_No", "Block", "Row", 
                                "Col", "ProductID", "B4R.Designation"))
# Characters/factors to numeric
    raw.data<- chtonumr(raw.data, c("DTF", "PH", "YKGH"))
# Check the problem with some of the factor levels. Let us fix it. 
    levels(raw.data$Design)
# Rename the Design levels
    levels(raw.data$Design)[levels(raw.data$Design)=="Alpha-Lattice"] <-"Alpha-lattice"
# Now the data has three designs Alpha latice, augmented RCBD and RCBD
# Now check the structure again
    str(raw.data)
# Creat unique id for trail names for stresss and non stress.
    raw.data<-within(raw.data, Trial_name <- paste(raw.data$Year, raw.data$Treatment, raw.data$Season, sep='-'))
#raw.data<- transform(raw.data,Trial_name=as.numeric(factor(raw.data$Study_Name)))
    raw.data$Trial_name<-as.factor(raw.data$Trial_name)
# Total Unique trials
    nlevels(raw.data$Trial_name)
# MISSING DATA
# First let us convert the zero values into missing data
# Check any zero value in yield, flowering and height data
    table(raw.data$YKGH==0) # Foe yield
    table(raw.data$PH==0) # For plant height
    table(raw.data$DTF==0) # for flowerinf data
# Only yield data has zero values. Let us convert it into missing values
    raw.data$YKGH[raw.data$YKGH==0]<-NA
    raw.data$YKGH[raw.data$YKGH>10000]<-NA
# Convert unexpected and large height values into missing
    raw.data$PH[raw.data$PH>200]<-NA
```

## Check and Plot Missing Data

```{r, eval=FALSE}
  na_count <-sapply(raw.data, function(y) sum(length(which(is.na(y)))))
  barplot(na_count, las=3, ylab="Frequency",xlab="",
        main="Bar plot of missing values.", col = "skyblue")
# Some values are missing in B4R.Designation which will be used as factor for analysis
  table(is.na(raw.data$B4R.Designation))
# First subset the data based on required columns
  missing.data<-raw.data[,c(6,14, 15,16, 23)]
# Now get missing data count
  Data.missing<-data.frame(missing.data %>%group_by(Trial_name) %>%
                           summarise_each(funs(sum(is.na(.))/length(.))))
# Plot the missing plot for Grain Yield
  png(file = "./Outputs/Figures/Prop.missing.data.yield.png", width =12, 
    height =6, units = "in", res = 600)
  ggplot(Data.missing, aes(x=Trial_name, y=YKGH))+ 
  geom_point(size=3) + 
  geom_segment(aes(x=Trial_name, 
                   xend=Trial_name, 
                   y=0, 
                   yend=YKGH)) + 
  labs(title="", y="Grain yield (Kg/ha)", x="Trials" )+
  theme_classic()+
  theme(axis.text.x = element_text(angle=90, vjust=0.6))+
  gghighlight(max(YKGH) > .05, label_key =Trial_name)+
  theme (plot.title = element_text(color="black", size=14, hjust=0.5),
         axis.title.x = element_text(color="black", size=24),
         axis.title.y = element_text(color="black", size=24))+
  theme(axis.text= element_text(color = "black", size = 10))
  dev.off()
#  Plot the missing plot for floweringh data 
  png(file = "./Outputs/Figures/Prop.missing.data.DTF.png", width =12, 
    height =6, units = "in", res = 600)
  ggplot(Data.missing, aes(x=Trial_name, y=DTF))+ 
  geom_point(size=3) + 
  geom_segment(aes(x=Trial_name, 
                   xend=Trial_name, 
                   y=0, 
                   yend=DTF)) + 
  labs(title="" , y="Days to flowering", x="Trials")+
  theme_classic()+
  theme(axis.text.x = element_text(angle=90, vjust=0.6))+
  gghighlight(max(DTF) > .05, label_key = Trial_name)+
  theme (plot.title = element_text(color="black", size=14, hjust=0.5),
         axis.title.x = element_text(color="black", size=24),
         axis.title.y = element_text(color="black", size=24))+
  theme(axis.text= element_text(color = "black", size = 10))
  dev.off()
```

# Identify and Plot Unique Lines

```{r, eval=FALSE}
  lines.unique<-data.frame(table(raw.data$B4R.Designation))
  length(lines.unique$Var1) # 2476 Unique lines
# Checking the testing duration of lines
  dur.data<- unique(raw.data[,c('B4R.Designation', 'Year')])
#hist(table(dur.data$ProductID), col='wheat', breaks=10, xlab='Number of testing years',
# main='Testing duration of lines')
  table.dur<-data.frame(table(dur.data$B4R.Designation))
  names(table.dur)<-c("Variable", "Years")
# Now plot histogram
  png(file = "./Outputs/Figures/Testing_years.png", width =4, 
    height = 4, units = "in", res = 600)
  ggplot(table.dur, aes(x=Years)) + geom_histogram()+
  geom_histogram(binwidth=2.5, color="black", fill="darkgrey")+ # adjust x values and breaks
  labs(title="",x="No. of Testing Years", y = "No. of Lines")+
  theme_classic()+
  theme (plot.title = element_text(color="black", size=14, hjust=0),
         axis.title.x = element_text(color="black", size=16),
         axis.title.y = element_text(color="black", size=16)) +
  theme(axis.text= element_text(color = "black", size = 8))
  dev.off()
  
```

# Check Trails and Conectivity of Genotypes 

```{r, eval=FALSE}
  data.trial<- raw.data[,c('Year','Treatment','Study_Name')]
  str(data.trial)
  TrailsTRT<-cast(data.trial, Treatment~Year, length)
  TrailsTRT
  levels((data.trial$Study_Name))
# Save the output in the folder
  write.xlsx(TrailsTRT, file = "./Outputs/Tables/Data_outputs.xlsx",
             sheetName = "Trials_Per_Treatment", append = FALSE)

# Now create a matrix showing overlap of lines across years
  year.data<- sort(unique(raw.data$Year))
  overlap<- matrix(nrow=length(year.data), ncol=length(year.data))
  colnames(overlap)<- year.data
  row.names(overlap)<- year.data
  for(i in 1:nrow(overlap)){
    for(j in 1:ncol(overlap)){
      level1<- unique(raw.data[which(raw.data$Year==year.data[i]),'B4R.Designation'])
      level2<- unique(raw.data[which(raw.data$Year==year.data[j]),'B4R.Designation'])
      overlap[i,j]<- length(intersect(level1, level2))
    }
  }
## Save the output in folder
  write.xlsx(overlap, file = "./Outputs/Tables/Data_outputs.xlsx",
             sheetName = "Conectivity of lines across years", append = TRUE)
  
# Draw the heatmap of connectivity

  png(file = "./Outputs/Figures/heatmap_conectivity.png", width = 12, 
      height = 9, units = "in", res =400)
  radioHeat(overlap, lowColor = "WHITE", highColor = "BLUE",diag = TRUE, threshold = FALSE, threshvalue = .1, 
            values = TRUE, textsize = 6, labelsize = 23)
  dev.off()
```

##  Summary Statistics for all Traits

```{r, eval=FALSE}
# For grain yield
  summary.ykgh<-data.frame(raw.data %>% 
                               group_by(Trial_name)%>% 
                              summarize(Mean = mean(YKGH, na.rm=TRUE),
                                            Median= median(YKGH, na.rm=TRUE),
                                            SD =sd(YKGH, na.rm=TRUE),
                                            Min.=min(YKGH, na.rm=TRUE),
                                            Max.=max(YKGH, na.rm=TRUE),
                                            CV=sd(YKGH, na.rm=TRUE)/mean(YKGH, na.rm=TRUE)*100,
                                            St.err= sd(YKGH, na.rm=TRUE)/sqrt(length(YKGH))
                                            ))
  summary.ykgh<-data.frame(lapply(summary.ykgh, function(y) if(is.numeric(y)) round(y, 2) else y)) 
  write.xlsx(summary.ykgh, file = "./Outputs/Tables/Data_outputs.xlsx",
           sheetName = "Descriptive_statistics_Raw_Yield", append = TRUE)
# Note down the CV of some of the trials
# For flowering date
  summary.dtf<-data.frame(raw.data %>% 
                           group_by(Trial_name)%>% 
                           summarize(Mean = mean(DTF, na.rm=TRUE),
                                     Median= median(DTF, na.rm=TRUE),
                                     SD =sd(DTF, na.rm=TRUE),
                                     Min.=min(DTF, na.rm=TRUE),
                                     Max.=max(DTF, na.rm=TRUE),
                                     CV=sd(DTF, na.rm=TRUE)/mean(DTF, na.rm=TRUE)*100,
                                     St.err= sd(DTF, na.rm=TRUE)/sqrt(length(DTF))
                           ))
  summary.dtf<-data.frame(lapply(summary.dtf, function(y) if(is.numeric(y)) round(y, 2) else y)) 
  write.xlsx(summary.dtf, file = "./Outputs/Tables/Data_outputs.xlsx",
           sheetName = "Descriptive_statistics_Raw_DTF", append = TRUE)

# For Plant Height
  summary.ph<-data.frame(raw.data %>% 
                          group_by(Trial_name)%>% 
                          summarize(Mean = mean(PH, na.rm=TRUE),
                                    Median= median(PH, na.rm=TRUE),
                                    SD =sd(PH, na.rm=TRUE),
                                    Min.=min(PH, na.rm=TRUE),
                                    Max.=max(PH, na.rm=TRUE),
                                    CV=sd(PH, na.rm=TRUE)/mean(PH, na.rm=TRUE)*100,
                                    St.err= sd(PH, na.rm=TRUE)/sqrt(length(PH))
                          ))
  summary.ph<-data.frame(lapply(summary.ph, function(y) if(is.numeric(y)) round(y, 2) else y)) 
  write.xlsx(summary.ph, file = "./Outputs/Tables/Data_outputs.xlsx",
           sheetName = "Descriptive_statistics_Raw_PH", append = TRUE)
```


## Distribution  of Traits

```{r, eval=FALSE}
# For grain Yield
  png(file = "./Outputs/Figures/Boxplot_Yield_Raw.Data.png", width =14, 
      height =8, units = "in", res = 500)
  boxplot.yield<-ggplot(raw.data, aes(x=Trial_name, y=YKGH, fill=Treatment, color=Treatment))+ 
    geom_boxplot()+
    theme_classic()+
    theme(axis.text.x = element_text(angle=90, vjust=0.6))+
    geom_boxplot(outlier.shape = 2)+
    stat_summary(fun=mean, geom="line", aes(group=Treatment), color="darkblue")  + 
    stat_summary(fun=mean, geom="point", size=2, aes(group=Treatment), color="darkred")+
    scale_fill_manual(values=c("#999999", "#E69F00"), name = "Treatement", labels = c("Normal", "Drought"))+
    scale_color_manual(values=c("#999999", "#E69F00"), name = "Treatement", labels = c("Normal", "Drought"))+
    labs(title="", 
         y="Grain yield (Kg/ha)", x="Trials")+
    theme (plot.title = element_text(color="black", size=14,face="bold", hjust=0.5),
           axis.title.x = element_text(color="black", size=24),
           axis.title.y = element_text(color="black", size=24))+
    theme(axis.text= element_text(color = "black", size = 14))+
    theme(legend.title = element_text(colour="black", size=24, face="bold"), legend.position = "top",
          legend.text = element_text(colour="black", size=22)) # add and modify the legends
  boxplot.yield
  dev.off()

# For DTF
  png(file = "./Outputs/Figures/Boxplot_DTF_Raw.Data.png", width =14, 
      height =8, units = "in", res = 500)
  boxplot.dtf<-ggplot(raw.data, aes(x=Trial_name, y=DTF, fill=Treatment, color=Treatment))+ 
    geom_boxplot()+
    theme_classic()+
    theme(axis.text.x = element_text(angle=90, vjust=0.6))+
    geom_boxplot(outlier.shape = 2)+
    stat_summary(fun=mean, geom="line", aes(group=Treatment), color="darkblue")  + 
    stat_summary(fun=mean, geom="point", size=2, aes(group=Treatment), color="darkred")+
    scale_fill_manual(values=c("#999999", "#E69F00"), name = "Treatement", labels = c("Normal", "Drought"))+
    scale_color_manual(values=c("#999999", "#E69F00"), name = "Treatement", labels = c("Normal", "Drought"))+
    labs(title="", 
         y="Days to flowering", x="Trials")+
    theme (plot.title = element_text(color="black", size=14,face="bold", hjust=0.5),
           axis.title.x = element_text(color="black", size=24),
           axis.title.y = element_text(color="black", size=24))+
    theme(axis.text= element_text(color = "black", size = 10))+
    theme(legend.title = element_text(colour="black", size=24, face="bold"), legend.position = "top",
          legend.text = element_text(colour="black", size=22))# add and modify the legends
    
  boxplot.dtf
  dev.off()

# For PH
  png(file = "./Outputs/Figures/Boxplot_PH_Raw.Data.png", width =14, 
      height =8, units = "in", res = 500)
  boxplot.ph<-ggplot(raw.data, aes(x=Trial_name, y=PH, fill=Treatment, color=Treatment))+ 
    geom_boxplot()+
    theme_classic()+
    theme(axis.text.x = element_text(angle=90, vjust=0.6))+
    geom_boxplot(outlier.shape = 2)+
    stat_summary(fun=mean, geom="line", aes(group=Treatment), color="darkblue")  + 
    stat_summary(fun=mean, geom="point", size=2, aes(group=Treatment), color="darkred")+
    scale_fill_manual(values=c("#999999", "#E69F00"), name = "Treatement", labels = c("Normal", "Drought"))+
    scale_color_manual(values=c("#999999", "#E69F00"), name = "Treatement", labels = c("Normal", "Drought"))+
    labs(title="", 
         y="Plant height (cm)", x="Trials")+
    theme (plot.title = element_text(color="black", size=14,face="bold", hjust=0.5),
           axis.title.x = element_text(color="black", size=24),
           axis.title.y = element_text(color="black", size=24))+
    theme(axis.text= element_text(color = "black", size = 10))+
    theme(legend.title = element_text(colour="black", size=24, face="bold"), legend.position = "top",
          legend.text = element_text(colour="black", size=22)) # add and modify the legends
  boxplot.ph
  dev.off()
```

## Check and Filter for Oultiers

```{r, eval=FALSE}
# We will use Using the Bonferroni- Holm test to remove the outliers
# We will subset the data sets based stress and non stress seperately
# First let us upoad the outlier function
  source("./R scripts/outlier.R")
# Subset non-stress data
  raw.data.ns<-subset(raw.data, Treatment=="Non-Stress")
  raw.data.ns<-droplevels.data.frame(raw.data.ns)
# Characters to factors
  raw.data.ns<- chtofact(raw.data.ns, c("Year", "Season","Treatment", "Design", "GID",
                                      "Study_Name", "Rep","Entry_No", "Block", "Row", 
                                      "Col", "ProductID", "B4R.Designation"))
# Subset stress data
  raw.data.st<-subset(raw.data, Treatment=="Stress")
  raw.data.st<-droplevels.data.frame(raw.data.st)
# Characters to factors
  raw.data.st<- chtofact(raw.data.st, c("Year", "Season","Treatment", "Design", "GID",
                                      "Study_Name", "Rep","Entry_No", "Block", "Row", 
                                      "Col", "ProductID", "B4R.Designation"))
# Now run the model to check for outliers (For Grain Yield under non-stress)

# GRAIN YIELD (NON-STRESS)
# Group data by year
  raw.data.ns<-raw.data.ns[with(raw.data.ns, order(Year)),]
# Run the model
  model.gy.ns<-asreml(fixed= YKGH ~B4R.Designation, random = ~Year+Season+Rep,
                     residual =~dsum(~id(units) |Year),
                     na.action=na.method(x="include"), data = raw.data.ns)
  plot(model.gy.ns)

# Now get outliers flag out for Grain yield
# Now get outliers in column for yield
  data.gy.ns.outlier<-outliers(raw.data.ns,model.gy.ns, name="Outlier.YKGH")
  table(data.gy.ns.outlier$Outlier.YKGH)
# Flowering date (Non-Stress)
# We will use flag outlier data for grain yield as input data
  model.dtf.ns<-asreml(fixed= DTF ~B4R.Designation, random = ~Year+Season+Rep,
                    residual =~dsum(~id(units) |Year),
                    na.action=na.method(x="include"), data = data.gy.ns.outlier)
  plot(model.dtf.ns)
# Now get outliers flag out for DTF
  data.ns.outlier<-outliers(data.gy.ns.outlier,model.dtf.ns, name="Outlier.DTF")
# We will convert the outliers into missing values and save the file for downatream analysis
  data.ns.outlier$YKGH<-ifelse(data.ns.outlier$Outlier.YKGH==".", data.ns.outlier$YKGH, NA)
  data.ns.outlier$DTF<-ifelse(data.ns.outlier$Outlier.DTF==".", data.ns.outlier$DTF, NA)
  remove.columns<- c("Outlier.YKGH", "Outlier.DTF")
  data.ns.outlier<-data.ns.outlier[, !(colnames(data.ns.outlier) %in% remove.columns)]
# Save the file 
  write.csv(data.ns.outlier, file="./Data/Filtered_outlier/Data.non.stress.fileterd.csv",
  row.names = FALSE)
# Now run the model to check for outliers in stress conditions
# GRAIN YIELD (STRESS)
# Group by the year
  raw.data.st<-raw.data.st[with(raw.data.st, order(Year)),]
  model.gy.st<-asreml(fixed= YKGH ~B4R.Designation, random = ~Year+Season+Rep,
                    residual =~dsum(~id(units) |Year),
                    na.action=na.method(x="include"), data = raw.data.st)
  plot(model.gy.st)

# Now get outliers flag out for Grain yield
# Now get outliers in column for yield
  data.gy.st.outlier<-outliers(raw.data.st,model.gy.st, name="Outlier.YKGH")
  table(data.gy.st.outlier$Outlier.YKGH)
# Flowering date (Non-Stress)
# We will use flag outlier data for grain yield as input data
  model.dtf.st<-asreml(fixed= DTF ~B4R.Designation, random = ~Year+Season+Rep,
                     residual =~dsum(~id(units) |Year),
                     na.action=na.method(x="include"), data = data.gy.st.outlier)
  plot(model.dtf.st)
# Now get outliers flag out for DTF
# Now get outliers in column for DTF
  data.st.outlier<-outliers(data.gy.st.outlier,model.dtf.st, name="Outlier.DTF")
# We will convert the outliers into missing values and save the file for downatream analysis
  data.st.outlier$YKGH<-ifelse(data.st.outlier$Outlier.YKGH==".", data.st.outlier$YKGH, NA)
  data.st.outlier$DTF<-ifelse(data.st.outlier$Outlier.DTF==".", data.st.outlier$DTF, NA)
  remove.colums<- c("Outlier.YKGH", "Outlier.DTF")
  data.st.outlier<-data.st.outlier[, !(colnames(data.st.outlier) %in% remove.colums)]
# Save the file 
  write.csv(data.st.outlier, file="./Data/Filtered_outlier/Data.stress.fileterd.csv",
          row.names = FALSE)
```


# Analysis of Drought Data

##  First Step Analysis

### Read Filtered Data

```{r}
  rm(list=ls())
# Set the Parent Working Directory first
  setwd("/Volumes/GoogleDrive/My Drive/Rainfed_Breeding_Lead/Historical_Data_analysis/Drought")
  raw.data.fil.ns<-read.csv(file="./Data/Filtered_outlier/Data.non.stress.fileterd.csv",
                           header = TRUE, stringsAsFactors = TRUE)
# Non-stress data
  str(raw.data.fil.ns)
  raw.data.fil.ns$Block<-as.factor(raw.data.fil.ns$Block)
  raw.data.fil.ns$Year<-as.factor(raw.data.fil.ns$Year)
  raw.data.fil.ns$Block<-as.factor(raw.data.fil.ns$Block)
  raw.data.fil.ns$Rep<-as.factor(raw.data.fil.ns$Rep)
# Stress Data
  raw.data.fil.st<-read.csv(file="./Data/Filtered_outlier/Data.stress.fileterd.csv",
                            header = TRUE, stringsAsFactors = TRUE)
  str(raw.data.fil.st)
  raw.data.fil.st$Block<-as.factor(raw.data.fil.st$Block)
  raw.data.fil.st$Year<-as.factor(raw.data.fil.st$Year)
  raw.data.fil.st$Block<-as.factor(raw.data.fil.st$Block)
  raw.data.fil.st$Rep<-as.factor(raw.data.fil.st$Rep)
# First let us convert the blocks as replications for augmented design
  levels(raw.data.fil.ns$Design)
  raw.data.fil.ns[which(raw.data.fil.ns$Design=='Augmented-RCBD'),'Rep']<-raw.data.fil.ns[which(raw.data.fil.ns$Design=='Augmented-RCBD'),'Block']
# For stress
  levels(raw.data.fil.st$Design)
  raw.data.fil.st[which(raw.data.fil.st$Design=='Augmented-RCBD'),'Rep']<-raw.data.fil.st[which(raw.data.fil.st$Design=='Augmented-RCBD'),'Block']
  levels(raw.data.fil.ns$Trial_name)
  levels(raw.data.fil.st$Trial_name)
```


### Extract BLUES For Non-Stress Data

```{r, eval=FALSE}
# For Non-Stress Data using DTF as co-variate
  raw.data.fil.ns$Year<- as.character(raw.data.fil.ns$Year)
  un.yr<- unique(raw.data.fil.ns$Year)
  for(i in 1:length(un.yr)){
    sub<- droplevels.data.frame(raw.data.fil.ns[which(raw.data.fil.ns$Year==un.yr[i]),])
    if (length(levels(sub$Season))>1){
      model<- asreml(fixed = YKGH ~B4R.Designation+DTF,random = ~Rep+Season+Block,
                     residual = ~idv(units),na.action=na.method(x="include"), data=sub)
    } else {
      model<- asreml(fixed = YKGH~B4R.Designation+DTF,random = ~Rep+Block,
                     residual = ~idv(units),na.action=na.method(x="include"), data=sub)
    }
    #test.model<- asreml(fixed = YKGH ~B4R.Designation,random = ~Rep+Season,
    # residual = ~idv(units),na.action=na.method(x="include"), data=sub)
    #png(file = "/Volumes/GoogleDrive/My Drive/Rainfed_Breeding_Lead/Historical_Data_analysis/Drought/Outputs/residual.png", width = 12, 
    # height = 12, units = "in", res = 600)
    # Save residual diagonsotic plots
    #setwd("/Volumes/GoogleDrive/My Drive/Rainfed_Breeding_Lead/Historical_Data_analysis/Drought/Outputs/Residuals_NS")
    #par(mar = c(5, 5, 5, 5))
    #par(mfrow=c(1,1))
    #for (j in 1:length(model)){
      #pdf(paste("Residual_plot",j,".pdf",sep=""))
     # plot(model$residuals, main=paste("Residuals",un.yr[i]), xlab="Units", 
           #col="blue", ylab="Residuals", cex=0.4,cex.lab=1.5, 
           #cex.axis=0.8, 
           #cex.main=1.5)
      #dev.off()
    #}
    predicted<-data.frame((predict(model, "B4R.Designation", sed=T))$pvals)
    predicted<-data.frame(predicted, Year=un.yr[i])
    if(i>1){
      BLUE.all.yield.ns<-rbind(BLUE.all.yield.ns, predicted)
    }
    else{
      BLUE.all.yield.ns<- predicted
    }
  }
# Now save the BLUES into the output folder
  write.csv( BLUE.all.yield.ns, file="./Outputs/Tables/BLUEs.Stage1.NS.csv",
            row.names = FALSE)
  BLUE.all.yield.ns<-read.csv(file="./Outputs/Tables/BLUEs.Stage1.NS.csv", header = TRUE)
# Plot the predicted values in Histogram
# Now draw the Histogram
  png(file = "./Outputs/Figures/Hist_BLUES_YIELD_NS.png", width =6, 
      height =6, units = "in", res = 500)
  BLUE.all.yield.ns<-na.omit(BLUE.all.yield.ns)
  hist.blues<-ggplot(data=BLUE.all.yield.ns, aes(predicted.value)) +
    geom_histogram(binwidth=2, breaks=seq(0, 10000, by =500), color="darkblue", fill="lightblue")+ # adjust x values and breaks
    geom_vline(aes(xintercept=mean(predicted.value)), # adding the line to represent mean
               color="darkred", linetype="dashed", size=1)+
    labs(title="",x="BLUEs", y = "Count")+
    theme_classic()+
    theme (plot.title = element_text(color="black", size=14, face="bold", hjust=0),
           axis.title.x = element_text(color="black", size=20),
           axis.title.y = element_text(color="black", size=20)) +
    theme(axis.text= element_text(color = "black", size = 14))
  hist.blues
  dev.off()
```

### Extract BLUES For Drought Data

```{r, eval=FALSE}
  raw.data.fil.st$Year<- as.character(raw.data.fil.st$Year)
  un.yr<- unique(raw.data.fil.st$Year)
  for(i in 1:length(un.yr)){
    sub<- droplevels.data.frame(raw.data.fil.st[which(raw.data.fil.st$Year==un.yr[i]),])
    if (length(levels(sub$Season))>1){
      model<- asreml(fixed = YKGH ~B4R.Designation+DTF,random = ~Rep+Season+Block,
                     residual = ~idv(units),na.action=na.method(x="include"), data=sub)
      
    } else {
      model<- asreml(fixed = YKGH~B4R.Designation+DTF,random = ~Rep,
                     residual = ~idv(units),na.action=na.method(x="include"), data=sub)
    }
    #test.model<- asreml(fixed = YKGH ~B4R.Designation,random = ~Rep+Season,
    # residual = ~idv(units),na.action=na.method(x="include"), data=sub)
    #png(file = "/Volumes/GoogleDrive/My Drive/Rainfed_Breeding_Lead/Historical_Data_analysis/Drought/Outputs/residual.png", width = 12, 
    # height = 12, units = "in", res = 600)
    # Save residual diagonsotic plots
   # setwd("/Volumes/GoogleDrive/My Drive/Rainfed_Breeding_Lead/Historical_Data_analysis/Drought/Outputs/Residuals_ST")
    #for (j in 1:length(model)){
      #pdf(paste("Residual_plot",j,".pdf",sep=""))
      #plot(model$residuals, main=paste("Residuals",un.yr[i]), xlab="Units", 
          # col="blue", ylab="Residuals", cex=0.4,cex.lab=1.5, 
           #cex.axis=0.8, 
           #cex.main=1.5)
      #dev.off()
    #}
    predicted<-data.frame((predict(model, "B4R.Designation", sed=T))$pvals)
    predicted<-data.frame(predicted, Year=un.yr[i])
    if(i>1){
      BLUE.all.yield.st<-rbind(BLUE.all.yield.st, predicted)
    }
    else{
      BLUE.all.yield.st<- predicted
    }
  }
  write.csv(BLUE.all.yield.st, file="./Outputs/Tables/BLUEs.Stage1.ST.csv",
            row.names = FALSE)
  
  BLUE.all.yield.st<-read.csv(file="./Outputs/Tables/BLUEs.Stage1.ST.csv", header = TRUE)
# Plot the predicted values in Histogram
# Now draw the Histogram
    png(file = "./Outputs/Figures/Hist_BLUES_YIELD_ST.png", width =6, 
        height =6, units = "in", res = 500)
    BLUE.all.yield.st<-subset(BLUE.all.yield.st,BLUE.all.yield.st$predicted.value>1)
    BLUE.all.yield.st<-na.omit(BLUE.all.yield.st)
    hist.blues<-ggplot(data=BLUE.all.yield.st, aes(predicted.value)) +
      geom_histogram(binwidth=2, breaks=seq(0, 5500, by =300), color="darkblue", fill="lightblue")+ # adjust x values and breaks
      geom_vline(aes(xintercept=mean(predicted.value)), # adding the line to represent mean
                 color="darkred", linetype="dashed", size=1)+
      labs(title="",x="BLUEs", y = "Count")+
      theme_classic()+
      theme (plot.title = element_text(color="black", size=14, face="bold", hjust=0),
             axis.title.x = element_text(color="black", size=20),
             axis.title.y = element_text(color="black", size=20)) +
      theme(axis.text= element_text(color = "black", size = 14))
    
    hist.blues
    dev.off()

```

### Heritability in Non-stress Environment

```{r, eval=FALSE}
# FOR NON STRESS DATA
  raw.data.fil.ns$Year<- as.character(raw.data.fil.ns$Year)
  un.yr<- unique(raw.data.fil.ns$Year)
  for(i in 1:length(un.yr)){
    sub<- droplevels.data.frame(raw.data.fil.ns[which(raw.data.fil.ns$Year==un.yr[i]),])
    if (length(levels(sub$Season))>1){
      model<- asreml(fixed = YKGH ~1,random = ~B4R.Designation+Rep+Season+Block,
                     residual = ~idv(units),na.action=na.method(x="include"), data=sub)
    #n.rep<-nlevels(sub$Rep)
   # n.Season<-nlevels(sub$Season)
    #n.Block<-nlevels(sub$Block)
    #tot.err<- n.rep* n.Season* n.Block
    #predicted.her.ns<-vpredict(model, hA ~  V4/(V1/(n.Season)+V2/(n.rep)+V3/(n.Block)+V4+V5/(tot.err)))
    vc.g <- summary(model)$varcomp['B4R.Designation','component']
    vc.g
    # Mean variance of a difference of two genotypic BLUEs
    vdBLUP.mat <- predict(model, classify="B4R.Designation", sed=TRUE)$sed^2 # obtain squared s.e.d. matrix 
    vdBLUP.avg <- mean(vdBLUP.mat[upper.tri(vdBLUP.mat, diag=FALSE)]) # take mean of upper triangle
    vdBLUP.avg
    #############
    # H2 Cullis #
    #############
    H2Cullis <- 1 - (vdBLUP.avg/(vc.g*2))
    H2Cullis
    } else {
    model<- asreml(fixed = YKGH~1,random = ~B4R.Designation+Rep+Block,
                   residual = ~idv(units),na.action=na.method(x="include"), data=sub)
   # n.rep<-nlevels(sub$Rep)
    #n.Block<-nlevels(sub$Block)
    #tot.err<- n.rep*n.Block
    #predicted.her.ns<-vpredict(model, hA ~  V3/(V1/( n.rep)+V2/( n.Block)+V3+V4/(tot.err)))
    vc.g <- summary(model)$varcomp['B4R.Designation','component']
    vc.g
    # Mean variance of a difference of two genotypic BLUEs
    vdBLUP.mat <- predict(model, classify="B4R.Designation", sed=TRUE)$sed^2 # obtain squared s.e.d. matrix 
    vdBLUP.avg <- mean(vdBLUP.mat[upper.tri(vdBLUP.mat, diag=FALSE)]) # take mean of upper triangle
    vdBLUP.avg
    #############
    # H2 Cullis #
    #############
    H2Cullis <- 1 - (vdBLUP.avg/(vc.g*2))
    H2Cullis
    }
  #test.model<- asreml(fixed = YKGH ~B4R.Designation,random = ~Rep+Season,
  # residual = ~idv(units),na.action=na.method(x="include"), data=sub)
  #png(file = "/Volumes/GoogleDrive/My Drive/Rainfed_Breeding_Lead/Historical_Data_analysis/Drought/Outputs/residual.png", width = 12, 
  # height = 12, units = "in", res = 600)
  # Save residual diagonsotic plots
  #setwd("/Volumes/GoogleDrive/My Drive/Rainfed_Breeding_Lead/Historical_Data_analysis/Drought/Outputs/Residuals_NS")
  #par(mar = c(5, 5, 5, 5))
  #par(mfrow=c(1,1))
  #for (j in 1:length(model)){
  #pdf(paste("Residual_plot",j,".pdf",sep=""))
  # plot(model$residuals, main=paste("Residuals",un.yr[i]), xlab="Units", 
  #col="blue", ylab="Residuals", cex=0.4,cex.lab=1.5, 
  #cex.axis=0.8, 
  #cex.main=1.5)
  #dev.off()
  #}
  #predicted.her.ns<-data.frame(predicted.her.ns, Year=un.yr[i])
  #if(i>1){
    #heritability.yld.NS<-rbind(heritability.yld.NS, predicted.her.ns)
  #}
  #else{
    #heritability.yld.NS<- predicted.her.ns
 # }
    heritability<-data.frame(H2Cullis, Year=un.yr[i])
    if(i>1){
    heritability.yld.ns<-rbind(heritability.yld.ns,heritability)
   }
    else{
    heritability.yld.ns<- heritability
    }
  }
# Now add the column to indicate non-stress data
  heritability.yld.ns<-data.frame(cbind(Treatment= c(rep("Non-stress",nrow(heritability.yld.ns))),  heritability.yld.ns))
```

### Heritability in Drought Environments

```{r, eval=FALSE}
  raw.data.fil.st$Year<- as.character(raw.data.fil.st$Year)
  un.yr<- unique(raw.data.fil.st$Year)
  for(i in 1:length(un.yr)){
  sub<- droplevels.data.frame(raw.data.fil.st[which(raw.data.fil.st$Year==un.yr[i]),])
  if (length(levels(sub$Season))>1){
    model<- asreml(fixed = YKGH ~1,random = ~B4R.Designation+Rep+Season,
                   residual = ~idv(units),na.action=na.method(x="include"), data=sub)
    #n.rep<-nlevels(sub$Rep)
    #n.Season<-nlevels(sub$Season)
    #n.Block<-nlevels(sub$Block)
    #tot.err<- n.rep* n.Season* n.Block
    #predicted.her.st<-vpredict(model, hA ~  V4/(V1/(n.Season)+V2/(n.rep)+V3/(n.Block)+V4+V5/(tot.err)))
    vc.g <- summary(model)$varcomp['B4R.Designation','component']
    vc.g
    # Mean variance of a difference of two genotypic BLUEs
    vdBLUP.mat <- predict(model, classify="B4R.Designation", sed=TRUE)$sed^2 # obtain squared s.e.d. matrix 
    vdBLUP.avg <- mean(vdBLUP.mat[upper.tri(vdBLUP.mat, diag=FALSE)]) # take mean of upper triangle
    vdBLUP.avg
    #############
    # H2 Cullis #
    #############
    H2Cullis <- 1 - (vdBLUP.avg/(vc.g*2))
    H2Cullis

    } else {
    model<- asreml(fixed = YKGH~1,random = ~B4R.Designation+Rep+Block,
                   residual = ~idv(units),na.action=na.method(x="include"), data=sub)
    #n.rep<-nlevels(sub$Rep)
    #n.Block<-nlevels(sub$Block)
    #tot.err<- n.rep*n.Block
    #predicted.her.st<-vpredict(model, hA ~  V3/(V1/( n.rep)+V2/( n.Block)+V3+V4/(tot.err)))
    vc.g <- summary(model)$varcomp['B4R.Designation','component']
    vc.g
    # Mean variance of a difference of two genotypic BLUEs
    vdBLUP.mat <- predict(model, classify="B4R.Designation", sed=TRUE)$sed^2 # obtain squared s.e.d. matrix 
    vdBLUP.avg <- mean(vdBLUP.mat[upper.tri(vdBLUP.mat, diag=FALSE)]) # take mean of upper triangle
    vdBLUP.avg
    #############
    # H2 Cullis #
    #############
    H2Cullis <- 1 - (vdBLUP.avg/(vc.g*2))
    H2Cullis
    }
  #test.model<- asreml(fixed = YKGH ~B4R.Designation,random = ~Rep+Season,
  # residual = ~idv(units),na.action=na.method(x="include"), data=sub)
  #png(file = "/Volumes/GoogleDrive/My Drive/Rainfed_Breeding_Lead/Historical_Data_analysis/Drought/Outputs/residual.png", width = 12, 
  # height = 12, units = "in", res = 600)
  # Save residual diagonsotic plots
  #setwd("/Volumes/GoogleDrive/My Drive/Rainfed_Breeding_Lead/Historical_Data_analysis/Drought/Outputs/Residuals_NS")
  #par(mar = c(5, 5, 5, 5))
  #par(mfrow=c(1,1))
  #for (j in 1:length(model)){
  #pdf(paste("Residual_plot",j,".pdf",sep=""))
  # plot(model$residuals, main=paste("Residuals",un.yr[i]), xlab="Units", 
  #col="blue", ylab="Residuals", cex=0.4,cex.lab=1.5, 
  #cex.axis=0.8, 
  #cex.main=1.5)
  #dev.off()
  #}
  #predicted.her.st<-data.frame(predicted.her.st, Year=un.yr[i])
  #if(i>1){
   # heritability.yld.ST<-rbind(heritability.yld.ST, predicted.her.st)
 # }
  #else{
   # heritability.yld.ST<- predicted.her.st
 # }
    heritability<-data.frame(H2Cullis, Year=un.yr[i])
    if(i>1){
      heritability.yld.st<-rbind(heritability.yld.st,heritability)
    }
    else{
      heritability.yld.st<- heritability
    }
  }

  heritability.yld.st<-data.frame(cbind(Treatment= c(rep("Drought",nrow(heritability.yld.st))), heritability.yld.st))

# Now rbind the heritability for Stress and Non-stress and plot it
  Heritability.all<-rbind(heritability.yld.ns, heritability.yld.st)
  str(Heritability.all)
  Heritability.all$Treatment<-as.factor(Heritability.all$Treatment)
  Heritability.all$Year<-as.factor(Heritability.all$Year)
  Heritability.all$H2Cullis<-round(Heritability.all$H2Cullis, 4)
# Some issues wihth year 2015
  Heritability.all$H2Cullis[Heritability.all$H2Cullis==0.0000]<-0.20
# Rename the column name
  names(Heritability.all)[2]<-"Heritability"
# Save them in excel summary file
  write.xlsx(Heritability.all, file = "./Outputs/Tables/Data_outputs.xlsx",
           sheetName = "Heritability.all", append = TRUE)
  
# Plot them in bar plot
  png(file = "./Outputs/Figures/Heritabilities.png", width =6, 
    height =6, units = "in", res = 500)
  ggbarplot(Heritability.all, x = "Year", y = "Heritability",
          fill = "Treatment",           # change fill color by mpg_level
          color = "white",  
         merge = TRUE,# Set bar border colors to white
          palette = "jco",            # jco journal color palett. see ?ggpar
          sort.by.groups =FALSE,
          x.text.angle = 90,          # Rotate vertically x axis texts
          ylab = "Heritability",
          xlab = FALSE,
          rotate=FALSE,
          x.text.col = TRUE,
          legend = "top",
          ggtheme =theme_classic() ,
          font.legend = 18,
          legend.title = "Treatment"
  )+
  font("xlab", size = 20, color = "black")+
  font("ylab", size = 20, color = "black")+
  font("xy.text", size = 16, color = "black")
  dev.off()
```


### Combined (Adjusted BLUES) analysis 

```{r, eval=FALSE}
  raw.data.fil.all<-rbind(raw.data.fil.ns, raw.data.fil.st)
# Check which has stress and which not
  table(raw.data.fil.all$Year,paste(raw.data.fil.all$Season,raw.data.fil.all$Treatment, sep="."))
# Now perform combined analysis
  raw.data.fil.all$Year<- as.character(raw.data.fil.all$Year)
  un.yr<- unique(raw.data.fil.all$Year)
  for(i in 1:length(un.yr)){
  sub<- droplevels.data.frame(raw.data.fil.all[which(raw.data.fil.all$Year==un.yr[i]),])
  if (length(levels(sub$Treatment))>1 & length(levels(sub$Season))>1){
    model<- asreml(fixed = YKGH ~B4R.Designation+DTF,random = ~Rep+Treatment+Season+Block,
                   residual = ~idv(units),na.action=na.method(x="include"), data=sub)
    
   } else {
    model<- asreml(fixed = YKGH~B4R.Designation+DTF,random = ~Rep+Block,
                   residual = ~idv(units),na.action=na.method(x="include"), data=sub)
   }
  #test.model<- asreml(fixed = YKGH ~B4R.Designation,random = ~Rep+Season,
  # residual = ~idv(units),na.action=na.method(x="include"), data=sub)
  #png(file = "/Volumes/GoogleDrive/My Drive/Rainfed_Breeding_Lead/Historical_Data_analysis/Drought/Outputs/residual.png", width = 12, 
  # height = 12, units = "in", res = 600)
  # Save residual diagonsotic plots
  # setwd("/Volumes/GoogleDrive/My Drive/Rainfed_Breeding_Lead/Historical_Data_analysis/Drought/Outputs/Residuals_ST")
  #for (j in 1:length(model)){
  #pdf(paste("Residual_plot",j,".pdf",sep=""))
  #plot(model$residuals, main=paste("Residuals",un.yr[i]), xlab="Units", 
  # col="blue", ylab="Residuals", cex=0.4,cex.lab=1.5, 
  #cex.axis=0.8, 
  #cex.main=1.5)
  #dev.off()
  #}
  predicted<-data.frame((predict(model, "B4R.Designation", sed=T))$pvals)
  predicted<-data.frame(predicted, Year=un.yr[i])
  if(i>1){
    BLUE.all.yield.com<-rbind(BLUE.all.yield.com, predicted)
  }
  else{
    BLUE.all.yield.com<- predicted
  }
  }
write.csv(BLUE.all.yield.com, file="./Outputs/Tables/BLUEs.combined.csv",
          row.names = FALSE)

# Plot the predicted values in Histogram
# Now draw the Histogram
png(file = "./Outputs/Figures/Hist_BLUES_YIELD_Combined.png", width =6, 
    height =6, units = "in", res = 500)
BLUE.all.yield.com<-subset(BLUE.all.yield.com,BLUE.all.yield.com$predicted.value>1)
BLUE.all.yield.com<-na.omit(BLUE.all.yield.com)
hist.blues<-ggplot(data=BLUE.all.yield.com, aes(predicted.value)) +
  geom_histogram(binwidth=0.1, breaks=seq(0, 6000, by =250), color="darkblue", fill="lightblue")+ # adjust x values and breaks
  geom_vline(aes(xintercept=mean(predicted.value)), # adding the line to represent mean
             color="darkred", linetype="dashed", size=1)+
  labs(title="",x="BLUEs", y = "Count")+
  theme_classic()+
  theme (plot.title = element_text(color="black", size=14, face="bold", hjust=0),
         axis.title.x = element_text(color="black", size=20),
         axis.title.y = element_text(color="black", size=20)) +
  theme(axis.text= element_text(color = "black", size = 14))

hist.blues
dev.off()

```

##Second Step Analysis

### Construct Pedigree Matrix

```{r}
  rm(list=ls()) # remove the previous history
  setwd("/Volumes/GoogleDrive/My Drive/Rainfed_Breeding_Lead/Historical_Data_analysis/Drought")

# CONSTRUCT PEDIGREE MATRIX  (A matrix)
# Upload whole pedigree file
  ped<-read.csv(file="./Data/Pedigrees/ped.finalv2.csv", header = TRUE)
# Find any duplicates 
 # ped[duplicated(ped$DESIGNATION)|duplicated(ped$DESIGNATION, fromLast=TRUE),]
# Assign the variables as factors 
  ped$DESIGNATION <- as.factor(ped$DESIGNATION)
  ped$Female <- as.factor(ped$Female)
  ped$Male <- as.factor (ped$Male)
## Now construct A matrix
A.matrix<-Amatrix(ped, ploidy=2)
# Save them in folder
write.csv(A.matrix, file ="./Data/Pedigrees/A.matrix.csv", row.names = TRUE)
saveRDS(A.matrix, file = "./Data/Pedigrees/A.matrix.rds")

```

### BLUPs and Reliability Under Non-Stress

```{r, eval=FALSE}
  rm(list=ls()) # remove previous history
  setwd("/Volumes/GoogleDrive/My Drive/Rainfed_Breeding_Lead/Historical_Data_analysis/Drought")
  
# Upload the BLUEs for non-stress, stress and combined analysis from stage 1
  BLUE.yield.ns<-read.csv(file="./Outputs/Tables/BLUEs.Stage1.NS.csv", header = TRUE) # non stress
# Upplaod pedigree matrix
  A.matrix<-readRDS(file="./Data/Pedigrees/A.matrix.rds")
  dim(A.matrix)
  table(is.na(A.matrix)) # check for any missing values
# Sub set the matrix for non-stress data
# first get unique ids 
  ns.unique.id<-data.frame(ID=unique(BLUE.yield.ns$B4R.Designation))
  ns.unique.id$ID<-gsub(" ", "",ns.unique.id$ID) # remove space
  str(ns.unique.id)
  dim(ns.unique.id)
# Now get the rownames of A matrix
  id.amtrix<-data.frame(ID=row.names(A.matrix))
# Now check same number of ids are present in both
  #check<-data.frame(id.amtrix[id.amtrix$ID%in%ns.unique.id$ID,])
# Now subset the matrix
  ns.amtrix<-A.matrix[row.names(A.matrix)%in%ns.unique.id$ID, colnames(A.matrix)%in%ns.unique.id$ID]
  dim(ns.amtrix) # Check dimensions
# Check wether elements are same and present in both
  all(row.names(ns.amtrix)%in%ns.unique.id$ID)
# Check for any missing values
  table(is.na(ns.amtrix))
# Now get weighted blues for second stage analysis
# First let us get weights
  wt<- BLUE.yield.ns$std.error^2
  wt<- 1/wt
#names(wt)<-"weights"
# Check for missing and convert it to 0
  wt[is.na(wt)] = 0
  str(wt)
# Get inverse of matrix
#Building inverse of A matrix 
#Ainv.ns <-solve(ns.amtrix)
# Now fit the model with A matrix and extract Breeding values/BLUPs
# Factor conversion
  BLUE.yield.ns$B4R.Designation<-as.factor(BLUE.yield.ns$B4R.Designation)
  BLUE.yield.ns$Year<-as.factor(BLUE.yield.ns$Year)
# Now run the model, will use full matrix rather than inverse  
asreml.options(gammaPar = TRUE)
model.ns.dr<-asreml(fixed= predicted.value ~1, random=~vm(B4R.Designation, ns.amtrix)+Year,
              workspace= 1000e06,weights=wt,
              na.action=na.method(x="include"), data=BLUE.yield.ns)
# Get the Breeding values (BLUPS)
  bv.dr.ns<- predict(model.ns.dr, classify='B4R.Designation', pworkspace='6gb')$pvals
# Estimate the reliabilities for each genotype
  PEV<-data.frame(PEV=bv.dr.ns$std.error^2)
# assign row names as designation for matching
  row.names(PEV)<-bv.dr.ns$B4R.Designation
# Get reliabilities
# Get genotype variance
  vgs<-summary(model.ns.dr)$varcomp[2,1]
  vgs
  reliability.ns.dr<- data.frame(Reliability=1-PEV/vgs)
# Now add reliability
  bv.dr.ns<-cbind(bv.dr.ns,reliability.ns.dr)
# Now calculate the heritability of the triat
# Mean variance of a difference of two genotypic BLUEs
  bv.mat.ns <- predict(model.ns.dr, classify="B4R.Designation", sed=TRUE, pworkspace='6gb')$sed^2 # obtain squared s.e.d. matrix 
  bv.avg.ns <- mean(bv.mat.ns[upper.tri(bv.mat.ns, diag=FALSE)]) # take mean of upper triangle
  heritability.ns <-1 -(bv.avg.ns/(vgs*2))
  heritability.ns  # 0.44
  
# Save the file into the folder
  write.csv(bv.dr.ns, file="./Outputs/Tables/BV.Stage2.NS.csv", row.names = FALSE)

# Now draw the Histogram
png(file = "./Outputs/Figures/BV.yield.ns.png", width =6, 
    height =6, units = "in", res = 500)
hist.blues.ns.bv<-ggplot(data=bv.dr.ns, aes(predicted.value)) +
  geom_histogram(bins = 20, color="darkblue", fill="lightblue")+ # adjust x values and breaks
  #geom_vline(aes(xintercept=mean(predicted.value)), # adding the line to represent mean
             #color="darkred", linetype="dashed", size=1)+
  labs(title="",x="Breeding values for yield", y = "Count")+
  theme_classic()+
  theme (plot.title = element_text(color="black", size=14, face="bold", hjust=0),
         axis.title.x = element_text(color="black", size=20),
         axis.title.y = element_text(color="black", size=20)) +
  theme(axis.text= element_text(color = "black", size = 14))

hist.blues.ns.bv
dev.off()

```

### BLUPs and Reliability Under Drought

```{r, eval=FALSE}
# FOR STRESS  (Drought) DATA
  rm(list=ls()) # remove previous history
  setwd("/Volumes/GoogleDrive/My Drive/Rainfed_Breeding_Lead/Historical_Data_analysis/Drought")
# Upload the BLUEs for non-stress, stress and combined analysis from stage 1
  BLUE.all.st<-read.csv(file="./Outputs/Tables/BLUEs.Stage1.ST.csv", header = TRUE) # stress
# Remove negative values and extreame low values
  BLUE.all.st$predicted.value<-ifelse(BLUE.all.st$predicted.value<0,NA, BLUE.all.st$predicted.value)
# Upplaod pedigree matrix
  A.matrix<-readRDS(file="./Data/Pedigrees/A.matrix.rds")
  table(is.na(A.matrix)) # check for any missing values
# Sub set the matrix for non-stress data
# first get unique ids 
  st.unique.id<-data.frame(ID=unique(BLUE.all.st$B4R.Designation))
  st.unique.id$ID<-gsub(" ", "",st.unique.id$ID) # remove space
  dim(st.unique.id)
# Now get the rownames of A matrix
  id.amtrix<-data.frame(ID=row.names(A.matrix))
# Now check same number of ids are present in both
#check<-data.frame(ID=id.amtrix[id.amtrix$ID%in%st.unique.id$ID,])
#check.np<-data.frame(ID=unique(st.unique.id$ID[!st.unique.id$ID %in%check$ID]))
# Now subset the matrix
  st.amtrix<-A.matrix[row.names(A.matrix)%in%st.unique.id$ID, colnames(A.matrix)%in%st.unique.id$ID]
  dim(st.amtrix) # Check dimensions
# Check wether elements are same and present in both
  all(row.names(st.amtrix)%in%st.unique.id$ID)
# Check for any missing values
  table(is.na(st.amtrix))
# Now get weighted blues for second stage analysis
# First let us get weights
  wt<- BLUE.all.st$std.error^2
  wt<- 1/wt
#names(wt)<-"weights"
# Check for missing and convert it to 0
  wt[is.na(wt)] = 0
  str(wt)
# Get inverse of matrix
#Building inverse of A matrix 
  #Ainv.st <- solve(st.amtrix)
  #str(BLUE.all.st)
# Now fit the model with A matrix and extract Breeding values/BLUPs
# Factor conversion
  BLUE.all.st$B4R.Designation<-as.factor(BLUE.all.st$B4R.Designation)
  BLUE.all.st$Year<-as.factor(BLUE.all.st$Year)
# Now run the model  
  asreml.options(gammaPar = TRUE)
  #model.st.dr<-asreml(fixed= predicted.value ~1,random=~vm(B4R.Designation, st.amtrix)+Year,
                   # workspace= 1000e06,weights=wt, 
                    #na.action=na.method(x="include"), data=BLUE.all.st)
  
  model.st.dr<-asreml(fixed= predicted.value ~1,random=~B4R.Designation+Year,
                      workspace= 1000e06,weights=wt,
                      na.action=na.method(x="include"), data=BLUE.all.st)
# Get the Breeding values (BLUPS)
  bv.dr.st<- predict(model.st.dr, classify='B4R.Designation', pworkspace='6gb')$pvals
# Estimate the reliabilities for each genotype
  PEV<-data.frame(PEV=bv.dr.st$std.error^2)
# assign row names as designation for matching
  row.names(PEV)<-bv.dr.st$B4R.Designation
# Get genotype variance
  vgst<-summary(model.st.dr)$varcomp[2,1]
  vgst
# Get reliabilities
  reliability.st.dr<- data.frame(Reliability=1-(PEV/vgst))
# Now add reliability
  bv.dr.st<-cbind(bv.dr.st,reliability.st.dr)
# Now calculate the heritability of the triat
# Mean variance of a difference of two genotypic BLUEs
  bv.mat.st <- predict(model.st.dr, classify="B4R.Designation", sed=TRUE, pworkspace='6gb')$sed^2 # obtain squared s.e.d. matrix 
  bv.avg.st <- mean(bv.mat.st[upper.tri(bv.mat.st, diag=FALSE)]) # take mean of upper triangle
  heritability.st <-1 -(bv.avg.st/(vgst*2))
  heritability.st # 0.46
# Save the file into the folder
  bv.dr.st$B4R.Designation<-gsub(" ", "", bv.dr.st$B4R.Designation)
  write.csv(bv.dr.st, file="./Outputs/Tables/BV.Stage2.ST.csv", row.names = FALSE)
# Now draw the Histogram
  png(file = "./Outputs/Figures/BV.yield.st.png", width =6, 
    height =6, units = "in", res = 500)
  hist.blues.st.bv<-ggplot(data=bv.dr.st, aes(predicted.value)) +
  geom_histogram(bins = 20, color="darkblue", fill="lightblue")+ # adjust x values and breaks
  #geom_vline(aes(xintercept=mean(predicted.value)), # adding the line to represent mean
  #color="darkred", linetype="dashed", size=1)+
  labs(title="",x="Breeding values for yield", y = "Count")+
  theme_classic()+
  theme (plot.title = element_text(color="black", size=14, face="bold", hjust=0),
         axis.title.x = element_text(color="black", size=20),
         axis.title.y = element_text(color="black", size=20)) +
  theme(axis.text= element_text(color = "black", size = 14))
  hist.blues.st.bv
  dev.off()
```

### BLUPs and Reliability Under Combined Data

```{r, eval=FALSE}
  rm(list=ls()) # remove previous history
  setwd("/Volumes/GoogleDrive/My Drive/Rainfed_Breeding_Lead/Historical_Data_analysis/Drought")
# Upload the BLUEs for non-stress, stress and combined analysis from stage 1
  BLUE.all.com<-read.csv(file="./Outputs/Tables/BLUEs.combined.csv", header = TRUE)
# Upplaod pedigree matrix
  A.matrix<-readRDS(file="./Data/Pedigrees/A.matrix.rds")
# Sub set the matrix for non-stress data
# first get unique ids 
  com.unique.id<-data.frame(ID=unique(BLUE.all.com$B4R.Designation))
  com.unique.id$ID<-gsub(" ", "",com.unique.id$ID) # remove space
  dim(com.unique.id)
# Now get the rownames of A matrix
  id.amtrix<-data.frame(ID=row.names(A.matrix))
# Now check same number of ids are present in both
  check<-data.frame(ID=id.amtrix[id.amtrix$ID%in%com.unique.id$ID,])
#check.np<-data.frame(ID=unique(st.unique.id$ID[!st.unique.id$ID %in%check$ID]))
# Now subset the matrix
  com.amtrix<-A.matrix[row.names(A.matrix)%in%com.unique.id$ID, colnames(A.matrix)%in%com.unique.id$ID]
  dim(com.amtrix) # Check dimensions
# Check wether elements are same and present in both
  all(row.names(com.amtrix)%in%com.unique.id$ID)
# Check for any missing values
  table(is.na(com.amtrix))
# Now get weighted blues for second stage analysis
# First let us get weights
  wt<- BLUE.all.com$std.error^2
  wt<- 1/wt
#names(wt)<-"weights"
# Check for missing and convert it to 0
  wt[is.na(wt)] = 0
  str(wt)
# Get inverse of matrix
#Building inverse of A matrix 
#Ainv.st <- solve(st.amtrix)
#str(BLUE.all.st)
# Now fit the model with A matrix and extract Breeding values/BLUPs
# Factor conversion
  BLUE.all.com$B4R.Designation<-as.factor(BLUE.all.com$B4R.Designation)
  BLUE.all.com$Year<-as.factor(BLUE.all.com$Year)
# Now run the model   
  asreml.options(gammaPar = TRUE)
  model.com<-asreml(fixed= predicted.value ~1, random=~vm(B4R.Designation, com.amtrix)+Year,
                    workspace= 1000e06,weights=wt,
                    na.action=na.method(x="include"), data=BLUE.all.com)
  #model.com<-asreml(fixed= predicted.value ~1, random=~B4R.Designation+Year,
                    #workspace= 1000e06,weights=wt,
                    #na.action=na.method(x="include"), data=BLUE.all.com)
  

# Get the Breeding values (BLUPS)
  bv.com<- predict(model.com, classify='B4R.Designation', pworkspace='6gb')$pvals
# Estimate the reliabilities for each genotype
  PEV<-data.frame(PEV=bv.com$std.error^2)
# assign row names as designation for matching
  row.names(PEV)<-bv.com$B4R.Designation
# Get genotype variance
  vgst<-summary(model.com)$varcomp[2,1]
  vgst
# Get reliabilities
  reliability.com<- data.frame(Reliability=1-(PEV/vgst))
# Now add reliability
  bv.com<-cbind(bv.com,reliability.com)
# Now calculate the heritability of the triat
# Mean variance of a difference of two genotypic BLUEs
  bv.mat.com <- predict(model.com, classify="B4R.Designation", sed=TRUE, pworkspace='6gb')$sed^2 # obtain squared s.e.d. matrix 
  bv.avg.com <- mean(bv.mat.com[upper.tri(bv.mat.com, diag=FALSE)]) # take mean of upper triangle
  heritability.com <-1 -(bv.avg.com/(vgst*2))
  heritability.com # 0.33
# Save the file into the folder
  write.csv(bv.com, file="./Outputs/Tables/BV.Stage2.COM_WP.csv", row.names = FALSE)

# Now draw the Histogram
png(file = "./Outputs/Figures/BV.yield.COM.png", width =6, 
    height =6, units = "in", res = 500)
hist.blues.com.bv<-ggplot(data=bv.com, aes(predicted.value))+
  geom_histogram(bins = 20, color="darkblue", fill="lightblue")+ # adjust x values and breaks
  #geom_vline(aes(xintercept=mean(predicted.value)), # adding the line to represent mean
  #color="darkred", linetype="dashed", size=1)+
  labs(title="",x="Breeding values for yield", y = "Count")+
  theme_classic()+
  theme (plot.title = element_text(color="black", size=14, face="bold", hjust=0),
         axis.title.x = element_text(color="black", size=20),
         axis.title.y = element_text(color="black", size=20)) +
  theme(axis.text= element_text(color = "black", size = 14))

hist.blues.com.bv
dev.off()
```


# Estimation of Genetic Trends

## Read the Data
```{r, eval=FALSE}
  rm(list=ls()) # remove previous history
  setwd("/Volumes/GoogleDrive/My Drive/Rainfed_Breeding_Lead/Historical_Data_analysis/Drought")
# Read the Stage 1 (BLUE) Data sets for adding Year of origin to Breeding values data
  BLUE.yield.ns<-read.csv(file="./Outputs/Tables/BLUEs.Stage1.NS.csv", 
                          header = TRUE, stringsAsFactors = TRUE) # non stress
  BLUE.yield.ns$B4R.Designation<-gsub(" ", "", BLUE.yield.ns$B4R.Designation) # remove space
  
  BLUE.all.st<-read.csv(file="./Outputs/Tables/BLUEs.Stage1.ST.csv", 
                        header = TRUE, stringsAsFactors = TRUE) # stress
  BLUE.all.st$B4R.Designation<-gsub(" ", "", BLUE.all.st$B4R.Designation) # remove space
  
  BLUE.all.com<-read.csv(file="./Outputs/Tables/BLUEs.combined.csv",
                         header = TRUE,stringsAsFactors = TRUE)
  BLUE.all.com$B4R.Designation<-gsub(" ", "", BLUE.all.com$B4R.Designation) # remove space

```
 
## Genetic Trend Under Non-stress 

```{r, eval=FALSE}
# Read the breeding values
  BV.Stage2.NS<-read.csv(file="./Outputs/Tables/BV.Stage2.NS.csv", header = TRUE) # NS
  dim(BV.Stage2.NS)
  #BLUE.yield.ns$B4R.Designation<-as.factor(BLUE.yield.ns$B4R.Designation)
  BLUE.yield.ns$Year<-as.numeric(BLUE.yield.ns$Year)
# Now regress on the year of origin of line
  BLUE.NS<-BLUE.yield.ns %>% 
  group_by(B4R.Designation) %>% 
  slice(which.min(Year))
# Now merge year information with breeding values
  BV.NS.final<-merge(BV.Stage2.NS,BLUE.NS[,c(1,5)], by="B4R.Designation")
# Now run the lm to get the slope and intercept
model.ns<-lm(predicted.value~Year, data =BV.NS.final)
sink("./Outputs/Tables/lm.model.ns.GT.text")
summary(model.ns)
mean(BV.NS.final$predicted.value)
sink()
# Now plot the trend in the ggplot
png(file = "./Outputs/Figures/Genetic_trend_BV_NS.png", width =6, 
    height =6, units = "in", res = 500)
p1.ns.geno<-ggplot(BV.NS.final, aes(Year, predicted.value)) +
geom_smooth(method=lm, se = TRUE,formula = y~x, fill = "red", 
            col='black', size=0.5, span =0.5)+
  scale_y_continuous(limits = c(3500, 6500))+
geom_point(colour = "gray", size =0.9)+
  labs(title="",x="Year", y = "Breeding values")+
  theme_bw()+
  theme (plot.title = element_text(color="black", size=14, face="bold", hjust=0),
         axis.title.x = element_text(color="black", size=20),
         axis.title.y = element_text(color="black", size=20)) +
  theme(axis.text= element_text(color = "black", size = 14))
p1.ns.geno
dev.off()
```

## Genetic Trend Under Drought 

```{r, eval=FALSE}
# Read BV for st data
BV.Stage2.ST<-read.csv(file="./Outputs/Tables/BV.Stage2.ST.csv", header = TRUE) # ST

#BLUE.yield.ns$B4R.Designation<-as.factor(BLUE.yield.ns$B4R.Designation)
BLUE.all.st$Year<-as.numeric(BLUE.all.st$Year)
# Now regress on the year of origin of line
BLUE.ST<-BLUE.all.st %>% 
  group_by(B4R.Designation) %>% 
  slice(which.min(Year))
# Now merge year information with breeding values

BV.ST.final<-merge(BV.Stage2.ST,BLUE.ST[,c(1,5)], by="B4R.Designation")
# Now run the lm to get the slope and intercept
model.st<-lm(predicted.value~Year, data =BV.ST.final)
sink("./Outputs/Tables/lm.model.ST.GT.text")
summary(model.st)
mean(BV.ST.final$predicted.value)
sink()

 # For the percentage calculations
# Now plot the trend in the ggplot
png(file = "./Outputs/Figures/Genetic_trend_BV_ST.png", width =6, 
    height =6, units = "in", res = 500)
p2.st.geno<-ggplot(BV.ST.final, aes(Year, predicted.value)) +
  geom_smooth(method=lm, se = TRUE,formula = y~x, fill = "red", 
              col='black', size=0.5, span =0.5)+
  #scale_y_continuous(limits = c(3500, 6500))+
  geom_point(colour = "gray", size =0.9)+
  labs(title="",x="Year", y = "Breeding values")+
  theme_bw()+
  theme (plot.title = element_text(color="black", size=14, face="bold", hjust=0),
         axis.title.x = element_text(color="black", size=20),
         axis.title.y = element_text(color="black", size=20)) +
  theme(axis.text= element_text(color = "black", size = 14))
p2.st.geno
dev.off()
```

## Genetic Trend Under Combined Data 

```{r, eval=FALSE}
# Read BV for combined data
BV.Stage2.COM<-read.csv(file="./Outputs/Tables/BV.Stage2.COM.csv", header = TRUE) # NS
#BLUE.yield.ns$B4R.Designation<-as.factor(BLUE.yield.ns$B4R.Designation)
BLUE.all.com$Year<-as.numeric(BLUE.all.com$Year)
# Now regress on the year of origin of line
BLUE.COM<-BLUE.all.com %>% 
  group_by(B4R.Designation) %>% 
  slice(which.min(Year))
# Now merge year information with breeding values
BV.COM.final<-merge(BV.Stage2.COM,BLUE.COM[,c(1,5)], by="B4R.Designation")
# Now run the lm to get the slope and intercept
#BV.COM.final<-subset(BV.COM.final, Line.type=="check")
model.com<-lm(predicted.value~Year, data =BV.COM.final)
sink("./Outputs/Tables/lm.model.COM.GT.text")
summary(model.com)
mean(BV.COM.final$predicted.value) # For the percentage calculations
sink()
# Now plot the trend in the ggplot
png(file = "./Outputs/Figures/Genetic_trend_BV_COM.png", width =6, 
    height =6, units = "in", res = 500)
p3.com.geno<-ggplot(BV.COM.final, aes(Year, predicted.value)) +
  geom_smooth(method=lm, se = TRUE,formula = y~x, fill = "red", 
              col='black', size=0.5, span =0.5)+
  #scale_y_continuous(limits = c(3500, 6500))+
  geom_point(colour = "gray", size =0.9)+
  labs(title="",x="Year", y = "Breeding values")+
  theme_bw()+
  theme (plot.title = element_text(color="black", size=14, face="bold", hjust=0),
         axis.title.x = element_text(color="black", size=20),
         axis.title.y = element_text(color="black", size=20)) +
  theme(axis.text= element_text(color = "black", size = 14))
p3.com.geno
dev.off()
```

## Plot of Genetic Trends for All

```{r, eval=FALSE}
# Now let us merge the three figures 
library(gridExtra)
png(file = "./Outputs/Figures/Genetic_trend_all.png", width =12, 
    height =6, units = "in", res = 500)
gt.genotype.all<-grid.arrange(p1.ns.geno, p2.st.geno,p3.com.geno, ncol=3)
gt.genotype.all
dev.off()
```

# Estimation of Genetic Trend for Checks

# Read the Data

```{r, eval=FALSE}
# Now upload the raw data for check information 
# Set the Parent Working Directory first
rm(list=ls())
setwd("/Volumes/GoogleDrive/My Drive/Rainfed_Breeding_Lead/Historical_Data_analysis/Drought")
# Read the raw data in Data folder
raw.data<-read.csv(file="./Data/AYT_Raw.Data.final.csv",
                   header = TRUE, sep=",", stringsAsFactors =FALSE)
raw.data$B4R.Designation<-gsub(" ", "", raw.data$B4R.Designation) # remove space
# Subset the required columns
data.check<-raw.data[,c(4, 2,13, 21)]
# Uppload the check data from Apurva's file
released_checks<-read_excel("./Outputs/Tables/Genetic_trend_checks/Checks_Relesed_Drought_Tolerant.xlsx",sheet=1)
released_checks<-released_checks[,c(1,2)]
names(released_checks)[2]<-"Year"
released_checks$B4R.Designation<-gsub(" ", "", released_checks$B4R.Designation) # remove space
# Now get checks/released lines for Non-stress data
#data.check.ns<-subset(data.check, Treatment=="Non-Stress" & Entry.Check=="Check")
# Now get the origin of check
#data.check.ns<-data.check.ns %>% 
  #group_by(B4R.Designation) %>% 
  #slice(which.min(Year))
# Drop Susceptible checks
#s.checks<-c("IRRI123", "IR64", "SWARNA", "SAMBHAMAHSURI", "IR36", "IRRI133", 
          #  "IRRI154", "Swarna-Sub1", "PR26016", "SABITA(NC492)", "BR11",
           # "SAVITHRI", "NSICRC122", "IRRI105", "IRRI149", "SAMBHAMAHSURI-SUB1", 
           # "CIHERANG", "Ciherang-Sub1", "NSICRc158", "THADOKKHAM1")
#data.check.ns1<-data.check.ns[!data.check.ns$B4R.Designation%in%s.checks,]

```

## Genetic Trend Under Non-stress 

```{r, eval=FALSE}
  BV.Stage2.NS<-read.csv(file="./Outputs/Tables/BV.Stage2.NS.csv", header = TRUE) # NS
  dim(BV.Stage2.NS)
  BV.Stage2.NS$B4R.Designation[BV.Stage2.NS$B4R.Designation=="UPLRI7"] <- "UPLRi7"
  BV.NS.check<-merge(released_checks,BV.Stage2.NS, by="B4R.Designation", all = FALSE)
  BV.NS.check<-BV.NS.check[, c(1,2,3)]
  BV.NS.check<-BV.NS.check[-22,]
  model.ns.check<-lm(predicted.value~Year, data =BV.NS.check)
  sink("./Outputs/Tables/Genetic_trend_checks/lm.model.NS.GT_CHECK.text")
  summary(model.ns.check)
  mean=4500 #
  mean
  sink()
# Now plot the trend in the ggplot
png(file = "./Outputs/Tables/Genetic_trend_checks/Genetic_trend_Check_NS.png", width =12, 
  height =8, units = "in", res = 500)
p1.ns.check<-ggplot(BV.NS.check, aes(Year, predicted.value)) +
  geom_smooth(method=lm, se = TRUE,formula = y~x, fill = "pink", 
              col='black', size=0.5, span =0.5)+
 scale_y_continuous(limits = c(4000, 5000))+
  scale_x_continuous(limits = c(1975, 2020))+
  #scale_x_discrete(limits = c(1970, 1980, 1990, 2000,2010, 2020))+
  geom_point(colour = "darkred", size =2)+
  #geom_text(aes(label=B4R.Designation),hjust=0, vjust=0, size=3, colour="darkred")+
  labs(title="",x="Year", y = "Breeding values")+
  theme_bw()+
  theme (plot.title = element_text(color="black", size=14, face="bold", hjust=0),
         axis.title.x = element_text(color="black", size=20),
         axis.title.y = element_text(color="black", size=20)) +
  theme(axis.text= element_text(color = "black", size = 14))
p1.ns.check<-p1.ns.check+geom_label_repel(data = BV.NS.check,aes(Year, predicted.value, 
                                              label=B4R.Designation))
p1.ns.check
dev.off()
```

## Genetic Trend Under Drought 


```{r, eval=FALSE}
# Now merge with breeding values
  BV.Stage2.ST<-read.csv(file="./Outputs/Tables/BV.Stage2.ST.csv", header = TRUE) # NS
  BV.Stage2.ST$B4R.Designation[BV.Stage2.ST$B4R.Designation=="UPLRI7"] <- "UPLRi7"
  BV.ST.check<-merge(released_checks,BV.Stage2.ST, by="B4R.Designation", all = FALSE)
  BV.ST.check<-BV.ST.check[, c(1,2,3)]
  BV.ST.check<-BV.ST.check[-22,]
  model.st.check<-lm(predicted.value~Year, data =BV.ST.check)
  sink("./Outputs/Tables/Genetic_trend_checks/lm.model.ST.GT_CHECK.text")
  summary(model.st.check)
  mean(BV.ST.check$predicted.value)
  sink()
# Now plot the trend in the ggplot
  png(file = "./Outputs/Tables/Genetic_trend_checks/Genetic_trend_Check_ST.png", width =12, 
      height =8, units = "in", res = 500)
  p2.st.check<-ggplot(BV.ST.check, aes(Year, predicted.value)) +
    geom_smooth(method=lm, se = TRUE,formula = y~x, fill = "pink", 
                col='black', size=0.5, span =0.6)+
    scale_y_continuous(limits = c(1200, 2600))+
    scale_x_continuous(limits = c(1975, 2019))+
    #scale_x_discrete(limits = c(1970, 1980, 1990, 2000,2010, 2020))+
    geom_point(colour = "darkred", size =2)+
    #geom_text(aes(label=B4R.Designation),hjust=0, vjust=0, size=3, colour="darkred")+
    labs(title="",x="Year", y = "Breeding values")+
    theme_bw()+
    theme (plot.title = element_text(color="black", size=14, face="bold", hjust=0),
           axis.title.x = element_text(color="black", size=20),
           axis.title.y = element_text(color="black", size=20)) +
    theme(axis.text= element_text(color = "black", size = 14))
  p2.st.check<-p2.st.check+geom_label_repel(data = BV.ST.check,aes(Year, predicted.value, 
                                                     label=B4R.Designation))
  p2.st.check
  dev.off()
```

## Genetic Trend Under Combined Data 

```{r, eval=FALSE}
# Now merge with breeding values
BV.Stage2.COM<-read.csv(file="./Outputs/Tables/BV.Stage2.COM_wp.csv", header = TRUE) # NS
BV.Stage2.COM$B4R.Designation<-gsub(" ", "", BV.Stage2.COM$B4R.Designation) # 
BV.Stage2.COM$B4R.Designation[BV.Stage2.COM$B4R.Designation=="UPLRI7"] <- "UPLRi7"
BV.COM.check<-merge(released_checks,BV.Stage2.COM, by="B4R.Designation", all = FALSE)

BV.COM.check<-BV.COM.check[, c(1,2,3)]
BV.COM.check<-BV.COM.check[-22,]
model.com.check<-lm(predicted.value~Year, data =BV.COM.check)
sink("./Outputs/Tables/Genetic_trend_checks/lm.model.COM.GT_CHECK.text")
summary(model.com.check)
#mean(BV.COM.check$predicted.value)
mean=2254
mean
sink()
# Now plot the trend in the ggplot
png(file = "./Outputs/Tables/Genetic_trend_checks/Genetic_trend_Check_COM.png", width =12, 
    height =8, units = "in", res = 500)
p3.com.check<-ggplot(BV.COM.check, aes(Year, predicted.value)) +
  geom_smooth(method=lm, se = TRUE,formula = y~x, fill = "pink", 
              col='black', size=0.5, span =0.5)+
  scale_y_continuous(limits = c(1400, 4100))+
  scale_x_continuous(limits = c(1975, 2020))+
  #scale_x_discrete(limits = c(1970, 1980, 1990, 2000,2010, 2020))+
  geom_point(colour = "darkred", size =2)+
  #geom_text(aes(label=B4R.Designation),hjust=0, vjust=0, size=3, colour="darkred")+
  labs(title="",x="Year", y = "Breeding values")+
  theme_bw()+
  theme (plot.title = element_text(color="black", size=14, face="bold", hjust=0),
         axis.title.x = element_text(color="black", size=20),
         axis.title.y = element_text(color="black", size=20)) +
  theme(axis.text= element_text(color = "black", size = 14))
p3.com.check<-p3.com.check+geom_label_repel(data = BV.COM.check,aes(Year, predicted.value, 
                                                   label=B4R.Designation))
p3.com.check
dev.off()
```

## Plot of Genetic Trends for All
```{r, eval=FALSE}
  png(file = "./Outputs/Tables/Genetic_trend_checks/Genetic_trend_all_check.png", width =12, 
      height =12, units = "in", res = 500)
  gt.check.all<-grid.arrange(p1.ns.check, p2.st.check,p3.com.check, ncol=2)
  gt.check.all
  dev.off()
```


#  Crossing Type information

```{r, eval=FALSE}
# Set the Parent Working Directory first
# Upload the line information in each year
rm(list=ls()) # remove previous history
setwd("/Volumes/GoogleDrive/My Drive/Rainfed_Breeding_Lead/Historical_Data_analysis/Drought")
# Upload the data containing cross type information
data.ct<-read_excel("./Outputs/Cross.type/AYT_Raw.Data.final.xlsx", sheet=1)
str(data.ct)
data.ct$Year<-as.factor(data.ct$Year)
data.ct$Season<-as.factor(data.ct$Season)
data.ct$Treatment<-as.factor(data.ct$Treatment)
data.ct$`B4R Designation`<-as.factor(data.ct$`B4R Designation`)
data.ct$Cross_Type<-as.factor(data.ct$Cross_Type)
data.ct<-data.ct[,c(2,3,4,16,21,23)]
# Now subset the Non-stress treatment only
data.ct1<-subset(data.ct, Treatment=="Non-Stress")
data.ct1<-droplevels.data.frame(data.ct1)
# Now add non-stress from 2003 and 2004
data.add<-subset(data.ct, Year=="2003" | Year=="2004")
# now combine two
data.ct2<-rbind(data.add,data.ct1)
data.ct2<-subset(data.ct2, Season=="DS")
data.ct2<-droplevels.data.frame(data.ct2)
data.ct2$`B4R Designation`<-gsub(" ", "", data.ct2$`B4R Designation`)
# Subset selected crosses
select<-c("Complex cross","Backcross",
          "Double cross", "Three-way cross",
          "Single cross")
data.ct2<-data.ct2[data.ct2$Cross_Type%in% select,]

# Plot
png(file = "./Outputs/Figures/Barplot_crosstype.png", width =8, 
    height =6, units = "in", res = 500)
ggplot(data=data.ct2, aes(Year), add = "mean") +
  geom_bar(aes(fill = Cross_Type))+
  theme_bw()+
  labs(title="",x="Year", y = "Count")+
  theme_bw()+
  theme (plot.title = element_text(color="black", size=14, hjust=0),
         axis.title.x = element_text(color="black", size=20),
         axis.title.y = element_text(color="black", size=20)) +
  theme(axis.text.x= element_text(color = "black", size = 14, angle = 90))+
  theme(axis.text.y= element_text(color = "black", size = 14))+
  theme(legend.title = element_text(colour="black", size=16, face="bold"), 
        legend.position = c(0.83, 0.82), legend.text = element_text(colour="black", 
      size=16))
dev.off()

```


# Relationship among the lines and PCA

```{r, eval=FALSE}
# FOR COMBINED (NON-STRESS AND Drought) DATA
rm(list=ls()) # remove previous history
setwd("/Volumes/GoogleDrive/My Drive/Rainfed_Breeding_Lead/Historical_Data_analysis/Drought")

# Upload the BLUEs for non-stress, stress and combined analysis from stage 1
BLUE.all.com<-read.csv(file="./Outputs/Tables/BLUEs.combined.csv", header = TRUE)
# Upplaod pedigree matrix
A.matrix<-readRDS(file="./Data/Pedigrees/A.matrix.rds")
# Sub set the matrix for non-stress data
# first get unique ids 
com.unique.id<-data.frame(ID=unique(BLUE.all.com$B4R.Designation))
com.unique.id$ID<-gsub(" ", "",com.unique.id$ID) # remove space
dim(com.unique.id)
# Now get the rownames of A matrix
id.amtrix<-data.frame(ID=row.names(A.matrix))
# Now check same number of ids are present in both
check<-data.frame(ID=id.amtrix[id.amtrix$ID%in%com.unique.id$ID,])
#check.np<-data.frame(ID=unique(st.unique.id$ID[!st.unique.id$ID %in%check$ID]))
# Now subset the matrix
com.amtrix<-A.matrix[row.names(A.matrix)%in%com.unique.id$ID, colnames(A.matrix)%in%com.unique.id$ID]
dim(com.amtrix) # Check dimensions
# Check wether elements are same and present in both
all(row.names(com.amtrix)%in%com.unique.id$ID)
# Check for any missing values
table(is.na(com.amtrix))
# Now perform PCA on A matrix
pca.amtrix<-PCA(com.amtrix, scale = TRUE, graph = FALSE)
#saveRDS(pca.amtrix, file = "pca.amtrix.rds")

# Get the name of core lines and check genotypes
core.names<-read_excel("./Outputs/Core_panel_selection/Core_Panel_Version1.xlsx", 
                       sheet=1)
#colnames(core.names)<-core.names[1,]
core.names<-core.names[-c(294, 295,296,297,298),]
core.names$B4R.Designation<-gsub(" ", "",core.names$B4R.Designation) # remove space
line.names<-data.frame(B4R.Designation=row.names(com.amtrix))
lines.names1<-merge(line.names, core.names, by="B4R.Designation", all=TRUE)
lines.names1<-lines.names1[, c(1,2,5)]
lines.names1$Line.info<-ifelse(is.na(lines.names1$Predicted.value), "Breeding lines", "Core lines")
lines.names1$Line.info2<-ifelse(!is.na(lines.names1$`Check Type`), "Checks", lines.names1$Line.info)
core.names$B4R.Designation<-as.factor(core.names$B4R.Designation)
B4R.Designation<-core.names$B4R.Designation
line.info<-as.factor(lines.names1$Line.info2)
library(factoextra)
png(file="./Outputs/Figures/Core.Panel.PCA.png", 
    width=8, height =6, units = 'in',res=400)
core.plot<-fviz_pca_ind(pca.amtrix,
             geom.ind = "point", # show points only (nbut not "text")
             col.ind = lines.names1$Line.info2, # color by groups
             addEllipses = FALSE, # Concentration ellipses
             legend.title = "Classification",
             palette = c("gray", "blue", "darkred"),
             pointsize = 2
)+
  theme_classic()+
  labs(title="",y="PC2 (8.6%)", x="PC1 (25.20%)")+ # Add the labels to the plots
  theme (plot.title = element_text(color="black", size=14,hjust=0.5), # add and modify the title to plot
         axis.title.x = element_text(color="black", size=20), # add and modify title to x axis
         axis.title.y = element_text(color="black", size=20)) + # add and modify title to y axis
  theme(axis.text= element_text(color = "black", size = 14))+
  theme(legend.title = element_text(colour="black", size=20, face="bold"),
        legend.position = c(0.70, 0.85), legend.text = element_text(colour="black", 
                                                                    size=20))
core.plot
dev.off()

png(file = "./Outputs/Figure2.MANUSCRIPT.png", width =12, 
    height =12, units = "in", res = 400)
plot2<-grid.arrange(p1.ns.check, p2.st.check,p3.com.check,core.plot, ncol=2)
plot2
dev.off()
```

***

*Note: For questions specific to analysis please contact waseem.hussain@irri.org and a.khanna@irri.org*

***
